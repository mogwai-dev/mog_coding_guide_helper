# Todo
30 分で実装できそうな作業単位に分ける

## Lexer で /* */ を識別できるようにする
2025/11/26 済

## とりあえず、Parser までかく
2025/11/27 済

## Lexer に Space を飛ばさない機能を追加する
2025/11/28 済

## Formatter でスペースを削除して表示する機能を付ける
2025/11/29 済

## 簡易 include 文機能の追加
2025/11/30 済

## 簡易 include 文のテスト
2025/11/30 済

## 簡易 define 文機能の追加
2025/11/30 済
・#include と #define の文末にコメントが入っていると、値の中に入ってしまう仕様になっている

## peek のリファクタリング
2025/12/2 済

## char_offsets のリファクタリング
2025/12/03 済
・token の line_end と column_end はもう少し考えたほうがいい

## 簡易 typedef 機能の追加
2025/12/05 済
・typedef は現状はまだ簡易実装。型テーブルができてない。typedef 宣言文を読めるだけ。

## 簡易 変数宣言機能の追加
2025/12/06 済
・修飾子は省くことにする。

## 簡易 struct 機能の追加
2025/12/07 済

## 簡易 関数定義 分析機能の追加
2025/12/08 済
・ブロック内は飛ばしている
・記憶域クラス指定子と修飾子は飛ばしている

## 簡易 enum, union 分析機能の追加
2025/12/08 済

## 簡易 extern 文の分析機能の追加
2025/12/08 済
・extern 文というものは実は存在しなくて、extern は記憶域クラス指定子なので宣言になる。

## 簡易 #if #ifdef #elif #else #endif の分析機能の追加
2025/12/10 済

## いくつかのフォーマッターの機能の追加
2025/12/10 済

## 文字連結機能の追加(バックスラッシュのあとに \n が入ったら次の行と結合する機能の追加)

## warning 出力機能の追加
2025/12/10 済

## vscode と結合
2025/12/10 済

## 記憶域クラス指定子 → 型修飾子 の順番で書いていない場合は警告を出す
### 背景
・コーディング規約・慣習
・Linux Kernel Coding Style、GNU Coding Standards、多くの企業のスタイルガイド
・可読性の観点から static const int の方が int const static より読みやすい
多くのプログラマーがこの順序に慣れている
・一貫性の観点からほとんどの既存コードがこの順序を使用

## レキサーで next_token 関数を読み込んで戻り値を match にかけて解析しているが、self.now を match にかけて解析が終わったら前に進めるという形のほうがソースコードが複雑になりにくいのでリファクタリングしたほうがいい
2025/12/07 済

## next_token のために enum TokenKind を準備して Token 自体は struct にして TokenKine の各種類の中に持たせる
2025/12/07 済

## ポインタ型の完全サポート
2025/12/11 済
・基本型とポインタ層の表現
・const/volatile/restrict/atomic 修飾子のサポート
・多段ポインタ (int***, etc.) の解析
・型安全性診断機能 (CGH101-104)
・型情報を使ったフォーマット出力

---

# コア機能の拡張（未実装部分）

## #ifdef / #if の条件評価機能 (実装済み)

## 関数本体（文）の解析 (実装済み)

## MISRA-C ルールチェック機能の追加
### 優先度: 高
・危険な構文の検出 (goto, 多重ポインタ, キャスト等)
・MISRA-C:2012 の主要ルールに対応
・違反箇所の診断出力

## volatile ポインタの特別扱い
### 優先度: 高
・レジスタアクセス用の volatile ポインタの検証
・volatile の付け忘れ警告
・volatile の不適切な使用検出

## ビットフィールドのサポート
### 優先度: 中
・レジスタ定義でよく使われる struct ビットフィールドの解析
・ビットフィールド幅の検証
・アライメント問題の検出

## アライメント指定のサポート
### 優先度: 中
・__attribute__((aligned(N))) の解析
・__attribute__((packed)) の解析
・コンパイラ固有の属性構文対応

## 関数ポインタ型のサポート
### 優先度: 中
・コールバック実装用の関数ポインタ型解析
・typedef された関数ポインタの追跡
・関数ポインタの型安全性チェック

## マクロ展開の改善
### 優先度: 低
・条件コンパイル (#if, #ifdef) の評価
・マクロ定義の追跡と展開
・マクロ使用箇所の検証

---

# 型システム強化（2025年12月13日実装）

## Phase 1: TypeTable構造改善
2025/12/13 完了
・TypeTable を HashMap<String, String> → HashMap<String, Type> に変更
・BaseType を型構造に適用（Int, Unsigned, Pointer等）
・Type::to_string() 実装
・169 テスト成功

## Phase 2: 複雑な typedef サポート
2025/12/13 完了
・関数ポインタ型の typedef 対応
・配列型の typedef 対応
・parse_type_and_declarator() 実装
・typedef 登録ロジックの改善（波括弧深度追跡）
・7 新規テスト追加（176 テスト成功）

## Phase 3: struct/union/enum キャストサポート
2025/12/13 完了
・BaseType に Struct(Option<String>), Union(Option<String>), Enum(Option<String>) 追加
・parse_type() で struct/union/enum キーワード認識
・parse_type_and_declarator() で名前付き struct/union/enum のみ許可（匿名型は失敗してフォールバック）
・ExpressionParser でのキャスト式認識拡張
・8 新規テスト追加（184 テスト成功）
・`(struct Point) x`, `(union Data) y`, `(enum Color) z` 形式のキャストに対応
・匿名enum typedef登録バグ修正（"RED"→"Color"）

## Phase 4: スコープ管理
2025/12/13 完了
・TypeTable にスコープスタック機能追加（Vec<HashMap<String, Type>>）
・push_scope/pop_scope メソッド実装
・is_type_name/get_type_info で最内スコープから外側へ検索
・scope_depth() メソッドでスコープレベル取得
・10 新規テスト追加（194 テスト成功）
・グローバルスコープ、スコープ分離、シャドーイング、スコープ深度管理

### 注意事項
・現在の実装では関数内ブロックは解析スキップされるため、関数内typedefは登録されない
・将来ブロック内解析を実装すれば、スコープ管理が完全に機能する

## 今後の拡張
### 完全な型情報の管理
・struct/union/enum の完全な定義をTypeTableに保存
・メンバ情報の管理（struct内のフィールド、enum値等）
・Function型とArray型の完全なType表現
・複雑な宣言子の完全解析
・関数内ブロック解析の実装

## include 文の処理。
2025/12/18 済
・実際に include する必要がある
・その際 ifdef, if はどうするか考える必要がある

## ローカル変数が 1 行で複数に実装されていたら警告。1 行では 1 つまで。

## ローカル変数のプリフィクス
型が VU8, VU16, VU32, VU64, VS8, VS16, VS32, VS64 であれば、ローカル変数のプリフィクスは u8_, u16_, u32_, u64_, s8_, s16_, s32_, s64_ とする。

## グローバル変数の const プリフィクス
const 付きの型 VU8, VU16, VU32, VU64, VS8, VS16, VS32, VS64 のグローバル変数のプリフィクスは CU8_, CU16_, CU32_, CU64_, CS8_, CS16_, CS32_, CS64_ とする。そうでなければ、診断で警告を出す。
これは、typedef で CU8, CU16, CU32, CU64, CS8, CS16, CS32, CS64 と typedef で定義されている場合があるので注意する。

## include パスを設定ファイルから設定できるようにする

## include ディレクトリがプロジェクトルートにない場合は診断で警告をする

## src ディレクトリがプロジェクトルートにない場合は診断で警告をする

## コーディング規約を適用しないファイルを指定できるようにする
内容は AI にまかせる。ディレクトリで適用しないファイルを隔離するか、設定ファイルで設定できるようにするのが無難。どっちがいいかは AI に聞いてみる。



